trigger:
- main

variables:
  IMAGE_NAME: voting-app-azure-dev-result
  TAG: $(Build.BuildId)
  DOCKER_HUB_USERNAME: akyldocker25

stages:
- stage: Build
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    displayName: Build and Push
    pool:
      name: azureagent  # your self-hosted Linux agent

    steps:
    # 1. Checkout repository
    - checkout: self
      displayName: Checkout Repository

    # 2. Install Docker and Buildx
    - script: |
        echo "Installing Docker and Buildx..."
        sudo apt-get update
        sudo apt-get install -y docker.io docker-buildx-plugin
        docker buildx version
      displayName: Install Docker & Buildx

    # 3. Add current user to Docker group
    - script: |
        echo "Updating Docker permissions..."
        sudo usermod -aG docker $(whoami)
        newgrp docker
      displayName: Adjust Docker Permissions

    # 4. Docker Hub login
    - task: Docker@2
      displayName: Docker Login
      inputs:
        command: login
        containerRegistry: docker-hub  # exact name of your service connection

    # 5. Build & push multi-platform Docker image
    - script: |
        echo "Building and pushing Docker image..."
        docker buildx create --use
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          -t $(DOCKER_HUB_USERNAME)/$(IMAGE_NAME):$(TAG) \
          -t $(DOCKER_HUB_USERNAME)/$(IMAGE_NAME):latest \
          -f result/Dockerfile result \
          --push
      displayName: Build and Push Docker Image
